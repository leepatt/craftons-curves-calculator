<!DOCTYPE html>
<html>
<head>
    <title>MDF Debug - Craftons Curves Calculator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 3px; max-height: 300px; overflow-y: scroll; font-family: monospace; font-size: 12px; }
        button { padding: 8px 16px; margin: 5px; }
        iframe { width: 100%; height: 600px; border: 1px solid #ddd; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    </style>
</head>
<body>
    <h1>MDF Material Selection Debug</h1>
    
    <div class="debug-section">
        <h3>Current Product Context</h3>
        <div id="context-display" class="status warning">Loading...</div>
        <button onclick="testMaterialMapping()">Test Material Mapping</button>
        <button onclick="sendTestContext()">Send Test Context</button>
        <button onclick="clearDebugLog()">Clear Log</button>
    </div>

    <div class="debug-section">
        <h3>Communication Debug Log</h3>
        <div id="debug-log" class="log">Initializing MDF debug test...\n</div>
    </div>

    <div class="debug-section">
        <h3>Material Validation</h3>
        <div id="material-validation" class="status warning">Checking materials...</div>
    </div>

    <div class="debug-section">
        <h3>Calculator Iframe</h3>
        <iframe 
            id="curves-calculator"
            src="http://localhost:3000"
            title="Craftons Curves Calculator">
        </iframe>
    </div>

    <script>
        // Initialize with MDF product context (simulating Shopify environment)
        window.productContext = {
            productId: "8234567890123",
            productTitle: "Craftons Radius Pro - MDF",
            material: "mdf-18",
            productHandle: "craftons-radius-pro-mdf"
        };

        let communicationAttempts = 0;
        let lastMessageReceived = null;

        function debugLog(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearDebugLog() {
            document.getElementById('debug-log').textContent = '';
        }

        function updateContextDisplay() {
            const contextDiv = document.getElementById('context-display');
            contextDiv.innerHTML = `
                <strong>Product ID:</strong> ${window.productContext.productId}<br>
                <strong>Product Title:</strong> ${window.productContext.productTitle}<br>
                <strong>Material ID:</strong> ${window.productContext.material}<br>
                <strong>Product Handle:</strong> ${window.productContext.productHandle || 'N/A'}
            `;
            contextDiv.className = 'status success';
        }

        function testMaterialMapping() {
            debugLog('Testing material mapping for MDF...');
            
            // Test the exact Liquid logic
            const productHandle = 'craftons-radius-pro-mdf';
            let expectedMaterial;
            
            switch(productHandle) {
                case 'craftons-radius-pro-formply':
                    expectedMaterial = 'form-17';
                    break;
                case 'craftons-radius-pro-mdf':
                    expectedMaterial = 'mdf-18';
                    break;
                case 'craftons-radius-pro-plywood':
                    expectedMaterial = 'CD-19';
                    break;
                default:
                    expectedMaterial = 'form-17';
            }
            
            debugLog(`Product handle: ${productHandle}`, 'info');
            debugLog(`Expected material: ${expectedMaterial}`, 'info');
            debugLog(`Current material: ${window.productContext.material}`, 'info');
            
            if (expectedMaterial === window.productContext.material) {
                debugLog('‚úÖ Material mapping is correct!', 'success');
            } else {
                debugLog('‚ùå Material mapping mismatch!', 'error');
            }
        }

        function sendTestContext() {
            debugLog('Manually sending product context to calculator...');
            
            const iframe = document.getElementById('curves-calculator');
            if (iframe && iframe.contentWindow) {
                try {
                    iframe.contentWindow.postMessage({
                        type: 'PRODUCT_CONTEXT_RESPONSE',
                        source: 'shopify-parent',
                        productContext: window.productContext
                    }, '*');
                    debugLog('Sent manual product context', 'success');
                    communicationAttempts++;
                } catch (error) {
                    debugLog(`Failed to send manual context: ${error.message}`, 'error');
                }
            } else {
                debugLog('Iframe not available for manual context send', 'error');
            }
        }

        async function validateMaterials() {
            const validationDiv = document.getElementById('material-validation');
            
            try {
                debugLog('Fetching materials.json...');
                const response = await fetch('/api/materials.json');
                const materials = await response.json();
                
                debugLog(`Loaded ${materials.length} materials`);
                
                const mdfMaterial = materials.find(m => m.id === 'mdf-18');
                if (mdfMaterial) {
                    debugLog(`‚úÖ Found MDF material: ${mdfMaterial.name} (${mdfMaterial.thickness_mm}mm)`, 'success');
                    validationDiv.innerHTML = `
                        <strong>‚úÖ MDF Material Found:</strong><br>
                        ID: ${mdfMaterial.id}<br>
                        Name: ${mdfMaterial.name}<br>
                        Thickness: ${mdfMaterial.thickness_mm}mm<br>
                        Price: $${mdfMaterial.sheet_price}
                    `;
                    validationDiv.className = 'status success';
                } else {
                    debugLog('‚ùå MDF material not found in materials.json!', 'error');
                    validationDiv.innerHTML = '‚ùå MDF material (mdf-18) not found in materials.json';
                    validationDiv.className = 'status error';
                }
                
                // List all available materials
                debugLog('Available materials:');
                materials.forEach(material => {
                    debugLog(`  - ${material.id}: ${material.name} (${material.thickness_mm}mm)`);
                });
                
            } catch (error) {
                debugLog(`Error loading materials: ${error.message}`, 'error');
                validationDiv.innerHTML = `‚ùå Error loading materials: ${error.message}`;
                validationDiv.className = 'status error';
            }
        }

        // Enhanced message listener with detailed logging
        window.addEventListener('message', function(event) {
            lastMessageReceived = event.data;
            debugLog(`üì® Received message: ${JSON.stringify(event.data)}`);
            
            // Handle product context requests with extra debugging
            if (event.data && 
                event.data.type === 'PRODUCT_CONTEXT_REQUEST' && 
                event.data.source === 'craftons-curves-calculator') {
                
                debugLog('üì• PRODUCT_CONTEXT_REQUEST received from calculator', 'success');
                debugLog(`Request details: ${JSON.stringify(event.data)}`);
                
                const iframe = document.getElementById('curves-calculator');
                if (iframe && iframe.contentWindow) {
                    try {
                        const responsePayload = {
                            type: 'PRODUCT_CONTEXT_RESPONSE',
                            source: 'shopify-parent',
                            productContext: window.productContext
                        };
                        
                        iframe.contentWindow.postMessage(responsePayload, '*');
                        debugLog(`üì§ Sent PRODUCT_CONTEXT_RESPONSE: ${JSON.stringify(responsePayload)}`, 'success');
                        communicationAttempts++;
                        
                    } catch (error) {
                        debugLog(`‚ùå Error sending response: ${error.message}`, 'error');
                        
                        // Try fallback method
                        try {
                            event.source.postMessage({
                                type: 'PRODUCT_CONTEXT_RESPONSE',
                                source: 'shopify-parent',
                                productContext: window.productContext
                            }, event.origin);
                            debugLog('‚úÖ Sent via fallback method', 'success');
                        } catch (fallbackError) {
                            debugLog(`‚ùå Fallback also failed: ${fallbackError.message}`, 'error');
                        }
                    }
                } else {
                    debugLog('‚ùå Iframe or contentWindow not available', 'error');
                }
            }
            
            // Handle height changes
            if (event.data && event.data.type === 'IFRAME_HEIGHT_CHANGE') {
                const iframe = document.getElementById('curves-calculator');
                if (iframe) {
                    iframe.style.height = `${event.data.height}px`;
                    debugLog(`üìè Height adjusted to ${event.data.height}px`);
                }
            }
            
            // Log any other calculator messages
            if (event.data && event.data.source === 'craftons-curves-calculator') {
                debugLog(`üì¨ Calculator message: ${event.data.type || 'unknown type'}`);
            }
        }, false);

        // Initialize debug session
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('üöÄ MDF Debug session started');
            updateContextDisplay();
            validateMaterials();
            testMaterialMapping();
            
            // Monitor communication attempts
            setInterval(() => {
                const statusDiv = document.querySelector('.debug-section h3');
                if (communicationAttempts > 0) {
                    statusDiv.textContent = `Communication Debug Log (${communicationAttempts} attempts)`;
                }
            }, 1000);
            
            debugLog('üéØ Waiting for calculator to request product context...');
        });
    </script>
</body>
</html> 