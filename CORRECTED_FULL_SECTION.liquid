{% comment %}
  Craftons Curves Calculator Custom Section
  Embeds the calculator directly into product pages
{% endcomment %}

<div class="curves-calculator-section" style="margin: {{ section.settings.margin_top }}px 0 {{ section.settings.margin_bottom }}px;">
  <div class="curves-calculator-container" style="max-width: 1600px; margin: 0 auto; padding: 0 20px;">
    {% if section.settings.show_title %}
      <h2 style="text-align: {{ section.settings.title_alignment }}; margin-bottom: 20px;">
        {{ section.settings.title }}
      </h2>
    {% endif %}
    
    {% if section.settings.show_description %}
      <div style="text-align: {{ section.settings.description_alignment }}; margin-bottom: 20px;">
        {{ section.settings.description }}
      </div>
    {% endif %}

    <div style="position: relative; width: 100%; border: {{ section.settings.border_width }}px solid {{ section.settings.border_color }}; border-radius: {{ section.settings.border_radius }}px; overflow: hidden; background: #f9f9f9;">
      <iframe 
        id="curves-calculator-iframe"
        src="https://craftons-curves-calculator.vercel.app"
        style="width: 100%; min-height: 800px; border: none; display: block; transition: height 0.3s ease-in-out;"
        frameborder="0"
        allowfullscreen
        loading="lazy"
        title="Craftons Curves Calculator">
      </iframe>
    </div>
    
    {% if section.settings.show_note %}
      <div style="margin-top: 15px; font-size: 0.9em; color: #666; text-align: {{ section.settings.note_alignment }};">
        {{ section.settings.note }}
      </div>
    {% endif %}
  </div>
</div>

<style>
  /* The media query for mobile height is removed as height is now dynamic. */
</style>

<script>
(function() {
  // Dynamic iframe height adjustment for Craftons Curves Calculator
  let calculatorIframe = null;
  let isResizing = false;
  
  // Find the calculator iframe
  function findCalculatorIframe() {
    const iframes = document.querySelectorAll('iframe[title="Craftons Curves Calculator"]');
    if (iframes.length > 0) {
      calculatorIframe = iframes[0];
      console.log('üì± Found Craftons Curves Calculator iframe');
    }
  }
  
  // Set up product context for automatic material selection
  window.productContext = {
    productId: {{ product.id | json }},
    productTitle: {{ product.title | json }},
    material: {% case product.handle %}
      {% when 'craftons-radius-pro-formply' %}
        "form-17"
      {% when 'craftons-radius-pro-mdf' %}
        "mdf-18"
      {% when 'craftons-radius-pro-plywood' %}
        "CD-19"
      {% else %}
        "form-17"
    {% endcase %}
  };
  
  // Handle messages from the calculator iframe
  function handleCalculatorMessages(event) {
    // Handle height change messages
    if (event.data && 
        event.data.type === 'IFRAME_HEIGHT_CHANGE' && 
        event.data.source === 'craftons-curves-calculator') {
      
      if (!calculatorIframe) {
        findCalculatorIframe();
      }
      
      if (calculatorIframe && !isResizing) {
        isResizing = true;
        const newHeight = event.data.height;
        
        console.log('üìè Adjusting iframe height to:', newHeight + 'px');
        
        // Smooth height transition
        calculatorIframe.style.transition = 'height 0.3s ease-out';
        calculatorIframe.style.height = newHeight + 'px';
        
        // Reset transition after animation
        setTimeout(() => {
          calculatorIframe.style.transition = '';
          isResizing = false;
        }, 300);
      }
    }
    
    // Handle product context requests from calculator iframe (fixes cross-origin issue)
    if (event.data && 
        event.data.type === 'PRODUCT_CONTEXT_REQUEST' && 
        event.data.source === 'craftons-curves-calculator') {
      
      console.log('üì• Received product context request from calculator iframe');
      
      // Send product context back to the iframe
      if (calculatorIframe && calculatorIframe.contentWindow) {
        try {
          calculatorIframe.contentWindow.postMessage({
            type: 'PRODUCT_CONTEXT_RESPONSE',
            source: 'shopify-parent',
            productContext: window.productContext
          }, '*');
          console.log('üì§ Sent product context to calculator iframe:', window.productContext);
        } catch (error) {
          console.warn('‚ùå Could not send product context to iframe:', error);
        }
      }
    }
  }
  
  // Set up message listener for all calculator communication
  window.addEventListener('message', handleCalculatorMessages, false);
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', findCalculatorIframe);
  } else {
    findCalculatorIframe();
  }
  
  // Fallback: find iframe after a delay in case it loads later
  setTimeout(findCalculatorIframe, 1000);
})();
</script>

{% schema %}
{
  "name": "Curves Calculator",
  "settings": [
    {
      "type": "header",
      "content": "Title Settings"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show title",
      "default": false
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Custom Curves Calculator"
    },
    {
      "type": "select",
      "id": "title_alignment",
      "label": "Title alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Description"
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show description",
      "default": false
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Calculate custom curved timber elements with real-time 3D visualization and instant pricing."
    },
    {
      "type": "select",
      "id": "description_alignment",
      "label": "Description alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Styling"
    },
    {
      "type": "range",
      "id": "border_width",
      "label": "Border width (px)",
      "min": 0,
      "max": 5,
      "step": 1,
      "default": 1
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border color",
      "default": "#e0e0e0"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border radius (px)",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 8
    },
    {
      "type": "range",
      "id": "margin_top",
      "label": "Top margin (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "label": "Bottom margin (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20
    },
    {
      "type": "header",
      "content": "Footer Note"
    },
    {
      "type": "checkbox",
      "id": "show_note",
      "label": "Show footer note",
      "default": false
    },
    {
      "type": "select",
      "id": "note_alignment",
      "label": "Note alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    }
  ],
  "presets": [
    {
      "name": "Curves Calculator",
      "settings": {
        "title": "Custom Curves Calculator",
        "show_title": false,
        "show_description": false
      }
    }
  ]
}
{% endschema %}