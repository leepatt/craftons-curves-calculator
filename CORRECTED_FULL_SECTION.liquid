{% comment %}
  Craftons Curves Calculator Custom Section
  Embeds the calculator directly into product pages
{% endcomment %}

<div class="curves-calculator-section" style="margin: {{ section.settings.margin_top }}px 0 {{ section.settings.margin_bottom }}px;">
  <div class="curves-calculator-container" style="max-width: 1600px; margin: 0 auto; padding: 0 20px;">
    {% if section.settings.show_title %}
      <h2 style="text-align: {{ section.settings.title_alignment }}; margin-bottom: 20px;">
        {{ section.settings.title }}
      </h2>
    {% endif %}
    
    {% if section.settings.show_description %}
      <div style="text-align: {{ section.settings.description_alignment }}; margin-bottom: 20px;">
        {{ section.settings.description }}
      </div>
    {% endif %}

    <div style="position: relative; width: 100%; border: {{ section.settings.border_width }}px solid {{ section.settings.border_color }}; border-radius: {{ section.settings.border_radius }}px; overflow: hidden; background: #f9f9f9;">
      <iframe 
        id="curves-calculator-iframe"
        src="https://craftons-curves-calculator.vercel.app"
        style="width: 100%; height: 620px; border: none; display: block; transition: height 0.3s ease-in-out;"
        frameborder="0"
        allowfullscreen
        loading="lazy"
        title="Craftons Curves Calculator">
      </iframe>
    </div>
    
    {% if section.settings.show_note %}
      <div style="margin-top: 15px; font-size: 0.9em; color: #666; text-align: {{ section.settings.note_alignment }};">
        {{ section.settings.note }}
      </div>
    {% endif %}
  </div>
</div>

<style>
  /* The media query for mobile height is removed as height is now dynamic. */
</style>

<script>
(function() {
  // Dynamic iframe height adjustment and product context for Craftons Curves Calculator
  let calculatorIframe = null;
  let isResizing = false;
  let messageListenerSetup = false;
  
  // Set up product context for automatic material selection
  window.productContext = {
    productId: {{ product.id | json }},
    productTitle: {{ product.title | json }},
    productHandle: {{ product.handle | json }},
    material: {% case product.handle %}
      {% when 'craftons-radius-pro-formply' %}
        "form-17"
      {% when 'craftons-radius-pro-mdf' %}
        "mdf-18"
      {% when 'craftons-radius-pro-mdf-standard' %}
        "mdf-18"
      {% when 'craftons-radius-pro-plywood' %}
        "BC-18"
      {% else %}
        "form-17"
    {% endcase %}
  };
  
  console.log('ðŸª Shopify product context set up:', window.productContext);
  console.log('ðŸ” Product handle debug:', {{ product.handle | json }});
  console.log('ðŸ” Material mapping result:', window.productContext.material);
  
  // Debug: Log exact handle comparison for MDF
  {% if product.handle == 'craftons-radius-pro-mdf' %}
    console.log('âœ… MDF product handle matched exactly');
  {% else %}
    console.log('âŒ MDF product handle did NOT match. Expected: craftons-radius-pro-mdf, Got:', {{ product.handle | json }});
  {% endif %}
  
  // Find the calculator iframe with multiple strategies
  function findCalculatorIframe() {
    // Strategy 1: Find by title attribute
    let iframes = document.querySelectorAll('iframe[title="Craftons Curves Calculator"]');
    if (iframes.length > 0) {
      calculatorIframe = iframes[0];
      console.log('ðŸ“± Found Craftons Curves Calculator iframe (by title)');
      return true;
    }
    
    // Strategy 2: Find by src containing calculator domain
    iframes = document.querySelectorAll('iframe');
    for (let iframe of iframes) {
      if (iframe.src && iframe.src.includes('craftons-curves-calculator')) {
        calculatorIframe = iframe;
        console.log('ðŸ“± Found Craftons Curves Calculator iframe (by src)');
        return true;
      }
    }
    
    // Strategy 3: Find by ID if set
    const iframeById = document.getElementById('curves-calculator-iframe');
    if (iframeById) {
      calculatorIframe = iframeById;
      console.log('ðŸ“± Found Craftons Curves Calculator iframe (by ID)');
      return true;
    }
    
    console.log('âš ï¸ Craftons Curves Calculator iframe not found yet');
    return false;
  }
  
  // Handle messages from the calculator iframe
  function handleCalculatorMessages(event) {
    // Handle height change messages
    if (event.data && 
        event.data.type === 'IFRAME_HEIGHT_CHANGE' && 
        event.data.source === 'craftons-curves-calculator') {
      
      if (!calculatorIframe) {
        findCalculatorIframe();
      }
      
      if (calculatorIframe && !isResizing) {
        isResizing = true;
        const newHeight = event.data.height;
        
        console.log('ðŸ“ Adjusting iframe height to:', newHeight + 'px');
        
        // Smooth height transition
        calculatorIframe.style.transition = 'height 0.3s ease-out';
        calculatorIframe.style.height = newHeight + 'px';
        
        // Reset transition after animation
        setTimeout(() => {
          calculatorIframe.style.transition = '';
          isResizing = false;
        }, 300);
      }
    }
    
    // Handle product context requests from calculator iframe
    if (event.data && 
        event.data.type === 'PRODUCT_CONTEXT_REQUEST' && 
        event.data.source === 'craftons-curves-calculator') {
      
      console.log('ðŸ“¥ Received product context request from calculator iframe');
      
      // Ensure we have the iframe reference
      if (!calculatorIframe) {
        findCalculatorIframe();
      }
      
      // Send product context back to the iframe
      if (calculatorIframe && calculatorIframe.contentWindow) {
        try {
          calculatorIframe.contentWindow.postMessage({
            type: 'PRODUCT_CONTEXT_RESPONSE',
            source: 'shopify-parent',
            productContext: window.productContext
          }, '*');
          console.log('ðŸ“¤ Sent product context to calculator iframe:', window.productContext);
        } catch (error) {
          console.warn('âŒ Could not send product context to iframe:', error);
          // Try alternative method - respond to any origin
          try {
            event.source.postMessage({
              type: 'PRODUCT_CONTEXT_RESPONSE',
              source: 'shopify-parent',
              productContext: window.productContext
            }, event.origin);
            console.log('âœ… Sent product context via event.source fallback');
          } catch (fallbackError) {
            console.error('âŒ Both postMessage methods failed:', fallbackError);
          }
        }
      } else {
        // Fallback: respond directly to the event source
        try {
          event.source.postMessage({
            type: 'PRODUCT_CONTEXT_RESPONSE',
            source: 'shopify-parent',
            productContext: window.productContext
          }, event.origin);
          console.log('âœ… Sent product context via direct event response');
        } catch (error) {
          console.error('âŒ Direct event response failed:', error);
        }
      }
    }
    
    // ðŸ›’ Handle ADD TO CART requests from calculator iframe
    // This allows the calculator to add items to cart WITHOUT replacing existing items
    // because this code runs on the Shopify domain (same-origin with /cart/add.js)
    if (event.data && 
        event.data.type === 'ADD_TO_CART_REQUEST' && 
        event.data.source === 'craftons-curves-calculator') {
      
      console.log('ðŸ›’ Received ADD_TO_CART_REQUEST from calculator iframe');
      console.log('ðŸ“¦ Cart data:', event.data.cartData);
      
      handleAddToCart(event.data.cartData, event.source, event.origin);
    }
  }
  
  // ðŸ›’ Add to cart handler - runs on Shopify domain so /cart/add.js works!
  async function handleAddToCart(cartData, eventSource, eventOrigin) {
    try {
      console.log('ðŸ›’ Adding to cart via Shopify AJAX API (same-origin)...');
      
      // Build the cart item payload
      const payload = {
        id: cartData.variantId,
        quantity: cartData.quantity,
        properties: cartData.properties || {}
      };
      
      console.log('ðŸ“¦ Payload:', JSON.stringify(payload, null, 2));
      
      // Call Shopify's /cart/add.js API - this ADDS to cart, doesn't replace!
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload),
        credentials: 'same-origin'
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('âŒ Cart API error:', response.status, errorText);
        
        // Send error back to iframe
        sendCartResponse(eventSource, eventOrigin, {
          success: false,
          error: `Cart API error (${response.status}): ${errorText}`
        });
        return;
      }
      
      const result = await response.json();
      console.log('âœ… Successfully added to cart:', result);
      
      // Send success response back to iframe
      sendCartResponse(eventSource, eventOrigin, {
        success: true,
        item: result
      });
      
      // Redirect to cart page after short delay (allows iframe to show success message)
      if (cartData.redirectToCart !== false) {
        setTimeout(() => {
          window.location.href = '/cart';
        }, 500);
      }
      
    } catch (error) {
      console.error('âŒ Error adding to cart:', error);
      
      // Send error back to iframe
      sendCartResponse(eventSource, eventOrigin, {
        success: false,
        error: error.message || 'Unknown error adding to cart'
      });
    }
  }
  
  // Send cart response back to the calculator iframe
  function sendCartResponse(eventSource, eventOrigin, response) {
    try {
      const message = {
        type: 'ADD_TO_CART_RESPONSE',
        source: 'shopify-parent',
        ...response
      };
      
      if (eventSource) {
        eventSource.postMessage(message, eventOrigin || '*');
        console.log('ðŸ“¤ Sent cart response to iframe:', response.success ? 'âœ… Success' : 'âŒ Error');
      } else if (calculatorIframe && calculatorIframe.contentWindow) {
        calculatorIframe.contentWindow.postMessage(message, '*');
        console.log('ðŸ“¤ Sent cart response via calculatorIframe reference');
      }
    } catch (error) {
      console.error('âŒ Could not send cart response:', error);
    }
  }
  
  // Set up message listener for all calculator communication
  function setupMessageListener() {
    if (!messageListenerSetup) {
      window.addEventListener('message', handleCalculatorMessages, false);
      messageListenerSetup = true;
      console.log('ðŸ‘‚ Message listener set up for calculator communication');
    }
  }
  
  // Initialize iframe detection and message handling
  function initialize() {
    console.log('ðŸš€ Initializing Craftons Curves Calculator integration');
    
    // Set up message listener first (before iframe loads)
    setupMessageListener();
    
    // Try to find iframe immediately
    findCalculatorIframe();
    
    // Set up multiple retry attempts for iframe detection
    const retryAttempts = [100, 500, 1000, 2000, 3000];
    retryAttempts.forEach((delay, index) => {
      setTimeout(() => {
        if (!calculatorIframe) {
          console.log(`ðŸ”„ Retry attempt ${index + 1} for iframe detection`);
          findCalculatorIframe();
        }
      }, delay);
    });
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }
})();
</script>

{% schema %}
{
  "name": "Curves Calculator",
  "settings": [
    {
      "type": "header",
      "content": "Title Settings"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show title",
      "default": false
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Custom Curves Calculator"
    },
    {
      "type": "select",
      "id": "title_alignment",
      "label": "Title alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Description"
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show description",
      "default": false
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Calculate custom curved timber elements with real-time 3D visualization and instant pricing."
    },
    {
      "type": "select",
      "id": "description_alignment",
      "label": "Description alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Styling"
    },
    {
      "type": "range",
      "id": "border_width",
      "label": "Border width (px)",
      "min": 0,
      "max": 5,
      "step": 1,
      "default": 1
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border color",
      "default": "#e0e0e0"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border radius (px)",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 8
    },
    {
      "type": "range",
      "id": "margin_top",
      "label": "Top margin (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "label": "Bottom margin (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20
    },
    {
      "type": "header",
      "content": "Footer Note"
    },
    {
      "type": "checkbox",
      "id": "show_note",
      "label": "Show footer note",
      "default": false
    },
    {
      "type": "select",
      "id": "note_alignment",
      "label": "Note alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    }
  ],
  "presets": [
    {
      "name": "Curves Calculator",
      "settings": {
        "title": "Custom Curves Calculator",
        "show_title": false,
        "show_description": false
      }
    }
  ]
}
{% endschema %}