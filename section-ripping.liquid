{% comment %}
  Craftons Ripping App Custom Section
  Embeds the ripping app directly into product pages
{% endcomment %}

<div class="section-ripping" style="margin: {{ section.settings.margin_top }}px 0 {{ section.settings.margin_bottom }}px;">
  <div class="section-ripping-container" style="max-width: 1600px; margin: 0 auto; padding: 0 20px;">
    {% if section.settings.show_title %}
      <h2 style="text-align: {{ section.settings.title_alignment }}; margin-bottom: 20px;">
        {{ section.settings.title }}
      </h2>
    {% endif %}
    
    {% if section.settings.show_description %}
      <div style="text-align: {{ section.settings.description_alignment }}; margin-bottom: 20px;">
        {{ section.settings.description }}
      </div>
    {% endif %}

    <div class="ripping-iframe-container" style="position: relative; width: 100%; border: {{ section.settings.border_width }}px solid {{ section.settings.border_color }}; border-radius: {{ section.settings.border_radius }}px; overflow: hidden; background: #f9f9f9; isolation: isolate;">
      <iframe 
        id="section-ripping-iframe"
        src="https://craftons-curves-calculator.vercel.app/apps/ripping"
        style="width: 100%; height: 920px; border: none; display: block; transition: height 0.3s ease-in-out; pointer-events: auto;"
        frameborder="0"
        allowfullscreen
        loading="lazy"
        sandbox="allow-scripts allow-same-origin allow-forms allow-top-navigation allow-popups"
        title="Craftons Ripping App">
      </iframe>
    </div>
    
    {% if section.settings.show_note %}
      <div style="margin-top: 15px; font-size: 0.9em; color: #666; text-align: {{ section.settings.note_alignment }};">
        {{ section.settings.note }}
      </div>
    {% endif %}
  </div>
</div>

<script>
(function() {
  // Prevent theme script conflicts by isolating our iframe operations
  'use strict';
  
  // Dynamic iframe height adjustment and product context for Craftons Ripping App
  const iframe = document.getElementById('section-ripping-iframe');
  const minHeight = 600;
  const maxHeight = 1400;
  
  // Defensive check to ensure iframe exists before any operations
  if (!iframe) {
    console.warn('Ripping app iframe not found');
    return;
  }

  function adjustIframeHeight(height) {
    const constrainedHeight = Math.max(minHeight, Math.min(maxHeight, height));
    if (iframe) {
      iframe.style.height = constrainedHeight + 'px';
      console.log(`üèóÔ∏è Section Ripping: Set iframe height to ${constrainedHeight}px`);
    }
  }

  // Listen for height change messages from the ripping app with error handling
  function handleIframeMessage(event) {
    try {
      // Allow both production and development origins
      const allowedOrigins = [
        'https://craftons-curves-calculator.vercel.app',
        'http://localhost:3000'
      ];
      
      if (!allowedOrigins.includes(event.origin)) {
        return;
      }

      const data = event.data;
      
      if (data && data.type === 'IFRAME_HEIGHT_CHANGE' && data.source === 'craftons-ripping-calculator') {
        console.log(`üìè Section Ripping: Received height update: ${data.height}px`);
        adjustIframeHeight(data.height);
      }
    } catch (error) {
      // Silently handle errors to prevent conflicts with theme scripts
      console.warn('Ripping app message handler error:', error);
    }
  }
  
  // Add message listener with error isolation
  try {
    window.addEventListener('message', handleIframeMessage, false);
  } catch (error) {
    console.warn('Could not set up ripping app message listener:', error);
  }

  // Set initial height
  adjustIframeHeight(920);
})();
</script>

{% schema %}
{
  "name": "Section: Ripping",
  "tag": "section",
  "class": "section-ripping",
  "settings": [
    {
      "type": "header",
      "content": "Title Settings"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show title",
      "default": true
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Sheet Ripping Calculator"
    },
    {
      "type": "select",
      "id": "title_alignment",
      "label": "Title alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Description Settings"
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show description",
      "default": true
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description",
      "default": "<p>Calculate costs for ripping down full sheets into custom strips with real-time visualization and instant pricing.</p>"
    },
    {
      "type": "select",
      "id": "description_alignment",
      "label": "Description alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Styling"
    },
    {
      "type": "range",
      "id": "border_width",
      "label": "Border width (px)",
      "min": 0,
      "max": 10,
      "step": 1,
      "default": 1
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border color",
      "default": "#e5e5e5"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border radius (px)",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 8
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "margin_top",
      "label": "Top margin (px)",
      "min": 0,
      "max": 100,
      "step": 10,
      "default": 40
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "label": "Bottom margin (px)",
      "min": 0,
      "max": 100,
      "step": 10,
      "default": 40
    },
    {
      "type": "header",
      "content": "Additional Info"
    },
    {
      "type": "checkbox",
      "id": "show_note",
      "label": "Show note",
      "default": true
    },
    {
      "type": "richtext",
      "id": "note",
      "label": "Note",
      "default": "<p>All prices include GST and are rounded up to the nearest whole dollar at checkout.</p>"
    },
    {
      "type": "select",
      "id": "note_alignment",
      "label": "Note alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    }
  ],
  "presets": [
    {
      "name": "Section: Ripping",
      "settings": {
        "title": "Custom Sheet Ripping Calculator",
        "show_title": true,
        "show_description": true,
        "description": "<p>Calculate costs for ripping down full sheets into custom strips with real-time visualization and instant pricing.</p>",
        "border_width": 1,
        "border_color": "#e5e5e5",
        "border_radius": 8,
        "margin_top": 40,
        "margin_bottom": 40
      }
    }
  ]
}
{% endschema %}
